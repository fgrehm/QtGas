.pragma library

/**
 * @license
 * Copyright (c) 2010 Zef Hemel <zef@zef.me>
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */

// Minified version of http://github.com/zefhemel/persistencejs
// Also removed JSON serializer

var persistence=window&&window.persistence?window.persistence:{}; (function(){function m(a,b,c){b=b+"__"+c;if(b in D){c=D[b];for(var d=0;d<c.length;d++)if(c[d]===a)return;D[b].push(a)}else D[b]=[a]}function p(a,b,c,d,e){a=a+"__"+b;if(a in D){a=D[a];for(var g=0;g<a.length;g++){var h=a[g],i=c._data;i[b]=d;var f=h._filter.match(i);i[b]=e;i=h._filter.match(i);f!=i&&h.triggerEvent("change",h,c)}}}function r(a){switch(a){case "JSON":return"TEXT";default:return a}}function M(a){function b(d){var e=this;this.id=U();this._new=true;this._type=a;this._dirtyProperties={};this._data= {};this._data_obj={};this.subscribers={};for(var g in c.fields)(function(){if(c.fields.hasOwnProperty(g)){var f=g;e.__defineSetter__(f,function(j){var k=e._data[f];e._data[f]=j;e._dirtyProperties[f]=true;e.triggerEvent("set",e,f,j);e.triggerEvent("change",e,f,j);p(a,f,e,k,j)});e.__defineGetter__(f,function(){return e._data[f]});e._data[g]=V(c.fields[g])}})();for(var h in c.hasOne)c.hasOne.hasOwnProperty(h)&&function(){var f=h;e.__defineSetter__(f,function(j){var k=e._data[f];if(j==null){e._data[f]= null;e._data_obj[f]=undefined}else if(j.id){e._data[f]=j.id;e._data_obj[f]=j;persistence.add(j)}else e._data[f]=j;e._dirtyProperties[f]=true;e.triggerEvent("set",e,f,j);e.triggerEvent("change",e,i,j);p(a,f,e,k,j)});e.__defineGetter__(f,function(){if(e._data[f]===null||e._data_obj[f]!==undefined)return e._data_obj[f];else if(e._data[f]!==null&&n[e._data[f]]){e._data_obj[f]=n[e._data[f]];return e._data_obj[f]}else throw"Property '"+f+"' with id: "+e._data[f]+" not fetched, either prefetch it or fetch it manually."; })}();for(h in c.hasMany)c.hasMany.hasOwnProperty(h)&&function(){var f=h;if(c.hasMany[f].manyToMany){e.__defineSetter__(f,function(){throw"Not yet supported.";});e.__defineGetter__(f,function(){if(this._data[f])return e._data[f];else{var j=c.hasMany[f].type.meta,k=new w(j.name);k.initManyToMany(e,f);k._additionalJoinSqls.push("LEFT JOIN `"+c.hasMany[f].tableName+"` AS mtm ON mtm.`"+j.name+"_"+c.hasMany[f].inverseProperty+"` = `"+j.name+"`.`id` ");k._additionalWhereSqls.push("mtm.`"+c.name+"_"+f+"` = '"+ e.id+"'");e._data[f]=k;return u(k)}})}else{e.__defineSetter__(f,function(){throw"Not yet supported.";});e.__defineGetter__(f,function(){if(this._data[f])return e._data[f];else{var j=u((new s(c.hasMany[f].type.meta.name)).filter(c.hasMany[f].inverseProperty,"=",e));return e._data[f]=j}})}}();for(var i in d)if(d.hasOwnProperty(i))e[i]=d[i]}if(E[a])return E[a];var c=v[a];b.prototype=new F;b.meta=c;b.prototype.equals=function(d){return this.id==d.id};b.prototype.fetch=function(d,e,g){var h=this;if(d)if(this._data[e])if(this._data_obj[e])g&& g(this._data_obj[e]);else c.hasOne[e].type.load(d,this._data[e],function(i){h._data_obj[e]=i;g&&g(i)});else g&&g(null);else persistence.transaction(function(i){h.fetch(i,e,g)})};b.prototype.markDirty=function(d){this._dirtyProperties[d]=true};b.all=function(){return u(new I(a))};b.load=function(d,e,g){if(d){e||g(null);d.executeSql("SELECT * FROM `"+a+"` WHERE id = ?",[e],function(h){h.length==0&&g(null);g(persistence.rowToEntity(a,h[0]))})}else persistence.transaction(function(h){b.load(h,e,g)})}; b.hasMany=function(d,e,g){var h=e.meta;if(h.hasMany[g]){var i=c.name+"_"+d+"_"+h.name,f=h.name+"_"+g+"_"+c.name;if(i>f)i=f;c.hasMany[d]={type:e,inverseProperty:g,manyToMany:true,tableName:i};h.hasMany[g]={type:b,inverseProperty:d,manyToMany:true,tableName:i};delete c.hasOne[d]}else{c.hasMany[d]={type:e,inverseProperty:g};h.hasOne[g]={type:b,inverseProperty:d}}};b.hasOne=function(d,e){c.hasOne[d]={type:e}};return E[a]=b}function S(a,b,c){var d=v[a._type],e=[],g=[],h=[],i=[];for(var f in a._dirtyProperties)if(a._dirtyProperties.hasOwnProperty(f)){e.push("`"+ f+"`");g.push(persistence.entityValToDbVal(a[f],d.fields[f]));h.push("?");i.push("`"+f+"` = ?")}var j=[];for(f in d.hasMany)if(d.hasMany.hasOwnProperty(f))j=j.concat(a[f].persistQueries());O(b,j,function(){if(e.length===0)c&&c();else{a._dirtyProperties={};if(a._new){e.push("id");g.push(a.id);h.push("?");var k="INSERT INTO `"+a._type+"` ("+e.join(", ")+") VALUES ("+h.join(", ")+")";a._new=false}else k="UPDATE `"+a._type+"` SET "+i.join(",")+" WHERE id = '"+a.id+"'";b.executeSql(k,g,c)}})}function T(a, b,c){var d=[["DELETE FROM `"+a._type+"` WHERE id = '"+a.id+"'",null]],e=persistence.getMeta(a._type);for(var g in e.hasMany)e.hasMany.hasOwnProperty(g)&&e.hasMany[g].manyToMany&&d.push(["DELETE FROM `"+e.hasMany[g].tableName+"` WHERE `"+e.name+"_"+g+"` = '"+a.id+"'",null]);O(b,d,c)}function O(a,b,c){function d(){var h=b.pop();a.executeSql(h[0],h[1],function(){if(b.length>0)d();else c&&c.apply(this,e)},function(i,f){console.log(f)})}for(var e=[],g=3;g<arguments.length;g++)e.push(arguments[g]);if(b.length> 0)d();else c&&c.apply(this,e)}function U(){for(var a=[],b=0;b<32;b++)a[b]="0123456789ABCDEF".substr(Math.floor(Math.random()*16),1);a[12]="4";a[16]="0123456789ABCDEF".substr(a[16]&3|8,1);return a.join("")}function V(a){switch(a){case "TEXT":return"";case "INT":return 0;case "BOOL":return false;default:return null}}function F(){this.subscribers={}}function J(){}function K(a,b){this.left=a;this.right=b}function L(a,b,c){this.property=a;this.operator=b;this.value=c}function u(a){var b=a.toUniqueString(); P[b]||(P[b]=a);return P[b]}function l(){}function s(a){this.init(a,s)}function I(a){this.init(a,I)}function w(a){this.init(a,w);this._localAdded=[];this._localRemoved=[]}function x(a){this.init(null,x);this._items=a||[]}var v={},n={},y={},D={},P={};persistence.getObjectsToRemove=function(){return y};persistence.getTrackedObjects=function(){return n};persistence.getMeta=function(a){return v[a]};persistence.connect=function(a,b,c,d){persistence._conn=persistence.db.connect(a,b,c,d);if(!persistence._conn)throw{type:"NoSupportedDatabaseFound", message:"No supported database found in this browser."};};persistence.transaction=function(a){if(persistence._conn)persistence._conn.transaction(a);else throw"No ongoing database connection, please connect first.";};persistence.define=function(a,b){if(v[a])return M(a);v[a]={name:a,fields:b,hasMany:{},hasOne:{}};return M(a)};var G={};persistence.schemaSync=function(a){var b=[],c,d,e,g;for(var h in v)if(v.hasOwnProperty(h)){c=v[h];d="";for(var i in c.fields)if(c.fields.hasOwnProperty(i))d+="`"+i+"` "+ r(c.fields[i])+", ";for(var f in c.hasOne)if(c.hasOne.hasOwnProperty(f)){e=c.hasOne[f].type.meta;d+=f+" VARCHAR(255), ";b.push(["CREATE INDEX IF NOT EXISTS `"+c.name+"_"+f+"_"+e.name+"` ON `"+c.name+"` (`"+f+"`)",null])}for(f in c.hasMany)if(c.hasMany.hasOwnProperty(f)&&c.hasMany[f].manyToMany){g=c.hasMany[f].tableName;if(!G[g]){e=c.hasMany[f].type.meta;b.push(["CREATE INDEX IF NOT EXISTS `"+g+"_"+c.name+"_"+f+"` ON `"+g+"` (`"+c.name+"_"+f+"`)",null]);b.push(["CREATE INDEX IF NOT EXISTS `"+g+"_"+ e.name+"_"+c.hasMany[f].inverseProperty+"` ON `"+g+"` (`"+e.name+"_"+c.hasMany[f].inverseProperty+"`)",null]);b.push(["CREATE TABLE IF NOT EXISTS `"+g+"` (`"+c.name+"_"+f+"` VARCHAR(32), `"+e.name+"_"+c.hasMany[f].inverseProperty+"` VARCHAR(32))",null]);G[g]=true}}d=d.substring(0,d.length-2);G[c.name]=true;b.push(["CREATE TABLE IF NOT EXISTS `"+c.name+"` ( id VARCHAR(32) PRIMARY KEY, "+d+")",null])}persistence.transaction(function(j){O(j,b,a,j)})};persistence.add=function(a){n[a.id]||(n[a.id]=a)}; persistence.remove=function(a){y[a.id]||(y[a.id]=a)};persistence.flush=function(a,b){if(a){var c=[];for(var d in n)n.hasOwnProperty(d)&&c.push(n[d]);var e=[];for(d in y)if(y.hasOwnProperty(d)){e.push(y[d]);delete n[d]}y={};if(b){var g=function(){var i=e.pop();T(i,a,function(){if(e.length>0)g();else b&&b()})},h=function(){var i=c.pop();S(i,a,function(){if(c.length>0)h();else if(e.length>0)g();else b&&b()})};if(c.length>0)h();else if(e.length>0)g();else b&&b()}else{for(d=0;d<c.length;d++)S(c[d],a); for(d=0;d<e.length;d++)T(e[d],a)}}else persistence.transaction(function(i){persistence.flush(i,b)})};persistence.clean=function(){n={}};persistence.reset=function(a){function b(){var e=c.pop();a.executeSql("DROP TABLE "+e,null,function(){c.length>0&&b()})}if(a){var c=[];for(var d in G)G.hasOwnProperty(d)&&c.push(d);b();persistence.clean();G={}}else persistence.transaction(function(e){persistence.reset(e)})};persistence.rowToEntity=function(a,b,c){c=c||"";if(n[b[c+"id"]])return n[b[c+"id"]];var d= v[a];a=M(a);if(!b[c+"id"])return null;a=new a;a.id=b[c+"id"];a._new=false;for(var e in b)if(b.hasOwnProperty(e))if(e.substring(0,c.length)===c){var g=e.substring(c.length);if(g!="id")a._data[g]=persistence.dbValToEntityVal(b[e],d.fields[g])}return a};persistence.dbValToEntityVal=function(a,b){switch(b){case "DATE":return new Date(parseInt(a,10)*1E3);case "BOOL":return a==1;case "JSON":return a?JSON.parse(a):a;default:return a}};persistence.entityValToDbVal=function(a,b){return a===undefined||a=== null?null:b==="JSON"&&a?JSON.stringify(a):a.id?a.id:b==="BOOL"?a?1:0:b=="DATE"?Math.round(a.getTime()/1E3):a};var E={};persistence.dump=function(a,b,c){if(!b){b=[];for(var d in E)E.hasOwnProperty(d)&&b.push(E[d])}for(var e=0,g={},h=0;h<b.length;h++)(function(){var i=b[h];i.all().list(a,function(f){g[i.meta.name]=f.map(function(j){var k={},t=i.meta.fields;for(var z in t)if(t.hasOwnProperty(z))k[z]=j._data[z];t=i.meta.hasOne;for(var A in t)if(t.hasOwnProperty(A))k[A]=j._data[A];k.id=j.id;return k}); e++;e===b.length&&c(g)})})()};persistence.load=function(a,b,c){for(var d in b)if(b.hasOwnProperty(d))for(var e=M(d),g=b[d],h=0;h<g.length;h++){var i=g[h],f=new e;for(var j in i)if(i.hasOwnProperty(j))f[j]=i[j];persistence.add(f)}persistence.flush(a,c)};persistence.dumpToJson=function(a,b,c){persistence.dump(a,b,function(d){c(JSON.stringify(d))})};persistence.loadFromJson=function(a,b,c){persistence.load(a,JSON.parse(json),c)};F.prototype.addEventListener=function(a,b){if(typeof a=="object")for(var c= a,d=0;d<c.length;d++){a=c[d];this.subscribers[a]||(this.subscribers[a]=[]);this.subscribers[a].push(b)}else{this.subscribers[a]||(this.subscribers[a]=[]);this.subscribers[a].push(b)}};F.prototype.removeEventListener=function(a,b){for(var c=this.subscribers[a],d=0;d<c.length;d++)if(c[d]==b){this.subscribers[a].splice(d,1);return true}return false};F.prototype.triggerEvent=function(a){if(this.subscribers[a])for(var b in this.subscribers[a])this.subscribers[a].hasOwnProperty(b)&&this.subscribers[a][b].apply(null, arguments)};J.prototype.sql=function(){return"1=1"};J.prototype.match=function(){return true};J.prototype.makeFit=function(){};J.prototype.makeNotFit=function(){};K.prototype.sql=function(a,b){return"("+this.left.sql(a,b)+" AND "+this.right.sql(a,b)+")"};K.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)};K.prototype.makeFit=function(a){this.left.makeFit(a);this.right.makeFit(a)};K.prototype.makeNotFit=function(a){this.left.makeNotFit(a);this.right.makeNotFit(a)};L.prototype.sql= function(a,b){if(this.operator==="="&&this.value===null)return"`"+a+this.property+"` IS NULL";else if(this.operator==="!="&&this.value===null)return"`"+a+this.property+"` IS NOT NULL";else{var c=this.value;if(c===true||c===false)c=c?1:0;b.push(persistence.entityValToDbVal(c));return"`"+a+this.property+"` "+this.operator+" ?"}};L.prototype.match=function(a){switch(this.operator){case "=":return a[this.property]===this.value;case "!=":return a[this.property]!==this.value;case "<":return a[this.property]< this.value;case "<=":return a[this.property]<=this.value;case ">":return a[this.property]>this.value;case ">=":return a[this.property]>=this.value}};L.prototype.makeFit=function(a){if(this.operator==="=")a[this.property]=this.value;else throw"Sorry, can't perform makeFit for other filters than =";};L.prototype.makeNotFit=function(a){if(this.operator==="=")a[this.property]=null;else throw"Sorry, can't perform makeNotFit for other filters than =";};l.prototype=new F;l.prototype.persistQueries=function(){return[]}; l.prototype.init=function(a,b){this._filter=new J;this._orderColumns=[];this._prefetchFields=[];this._additionalJoinSqls=[];this._additionalWhereSqls=[];this._entityName=a;this._constructor=b;this._limit=-1;this._skip=0;this.subscribers={}};l.prototype.toUniqueString=function(){var a=this._constructor.name+": "+this._entityName;a+="|Filter:";var b=[];a+=this._filter.sql("",b);a+="|Values:";for(var c=0;c<b.length;c++)a+=b+"|^|";a+="|Order:";for(c=0;c<this._orderColumns.length;c++){b=this._orderColumns[c]; a+=b[0]+", "+b[1]}a+="|Prefetch:";for(c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];a+="|JoinSQLs:";for(c=0;c<this._additionalJoinSqls.length;c++)a+=this._additionalJoinSqls[c];a+="|WhereSQLs:";for(c=0;c<this._additionalWhereSqls.length;c++)a+=this._additionalWhereSqls[c];a+="|Limit:";a+=this._limit;a+="|Skip:";a+=this._skip;return a};l.prototype.clone=function(a){var b=new this._constructor(this._entityName);b._filter=this._filter;b._prefetchFields=this._prefetchFields.slice(0); b._orderColumns=this._orderColumns.slice(0);b._additionalJoinSqls=this._additionalJoinSqls.slice(0);b._additionalWhereSqls=this._additionalWhereSqls.slice(0);b._limit=this._limit;b._skip=this._skip;if(a){a={};for(var c in this.subscribers)if(this.subscribers.hasOwnProperty(c))a[c]=subs.slice(0);b.subscribers=a}else b.subscribers=this.subscribers;return b};l.prototype.filter=function(a,b,c){var d=this.clone(true);d._filter=new K(this._filter,new L(a,b,c));d=u(d);m(d,this._entityName,a);return u(d)}; l.prototype.subscribeToAllFilters=function(){};l.prototype.order=function(a,b){b=b===undefined?true:b;var c=this.clone();c._orderColumns.push([a,b]);return u(c)};l.prototype.limit=function(a){var b=this.clone();b._limit=a;return u(b)};l.prototype.skip=function(a){var b=this.clone();b._skip=a;return u(b)};l.prototype.prefetch=function(a){var b=this.clone();b._prefetchFields.push(a);return u(b)};l.prototype.add=function(a){if(!a.id||!a._type)throw"Cannot add object of non-entity type onto collection."; persistence.add(a);this._filter.makeFit(a);this.triggerEvent("add",this,a);this.triggerEvent("change",this,a)};l.prototype.remove=function(a){if(!a.id||!a._type)throw"Cannot remove object of non-entity type from collection.";this._filter.makeNotFit(a);this.triggerEvent("remove",this,a);this.triggerEvent("change",this,a)};s.prototype=new l;s.prototype.each=function(a,b){if(a&&!a.executeSql){b=a;a=null}this.list(a,function(c){for(var d=0;d<c.length;d++)b(c[d])})};s.prototype.one=function(a,b){if(a&& !a.executeSql){b=a;a=null}this.limit(1).list(a,function(c){c.length===0?b(null):b(c[0])})};s.prototype.list=function(a,b){function c(o,B,C){var H=["`"+B+"`.id AS "+C+"id"];for(var q in o.fields)o.fields.hasOwnProperty(q)&&H.push("`"+B+"`.`"+q+"` AS `"+C+q+"`");for(q in o.hasOne)o.hasOne.hasOwnProperty(q)&&H.push("`"+B+"`.`"+q+"` AS `"+C+q+"`");return H}var d=this;if(a){for(var e=this._entityName,g=persistence.getMeta(e),h=[],i=e+"_",f=c(g,g.name,i),j=this._additionalJoinSqls.join(" "),k=0;k<this._prefetchFields.length;k++){var t= this._prefetchFields[k],z=g.hasOne[t].type.meta,A=z.name+"_"+t+"_tbl";f=f.concat(c(z,A,t+"_"));j+="LEFT JOIN `"+z.name+"` AS `"+A+"` ON `"+A+"`.`id` = `"+i+t+"` "}k="WHERE "+[this._filter.sql(i,h)].concat(this._additionalWhereSqls).join(" AND ");var N="SELECT "+f.join(", ")+" FROM `"+e+"` "+j+" "+k;if(this._orderColumns.length>0)N+=" ORDER BY "+this._orderColumns.map(function(o){return"`"+i+o[0]+"` "+(o[1]?"ASC":"DESC")}).join(", ");if(this._limit>=0)N+=" LIMIT "+this._limit;if(this._skip>0)N+=" OFFSET "+ this._skip;persistence.flush(a,function(){a.executeSql(N,h,function(o){for(var B=[],C=0;C<o.length;C++){for(var H=o[C],q=persistence.rowToEntity(e,H,i),Q=0;Q<d._prefetchFields.length;Q++){var R=d._prefetchFields[Q];q[R]=persistence.rowToEntity(g.hasOne[R].type.meta.name,H,R+"_")}B.push(q);persistence.add(q)}b(B);d.triggerEvent("list",d,B)})})}else persistence.transaction(function(o){d.list(o,b)})};I.prototype=new s;I.prototype.add=function(a){persistence.add(a);this.triggerEvent("add",this,a);this.triggerEvent("change", this,a)};I.prototype.remove=function(a){persistence.remove(a);this.triggerEvent("remove",this,a);this.triggerEvent("change",this,a)};w.prototype=new s;w.prototype.initManyToMany=function(a,b){this._obj=a;this._coll=b};w.prototype.add=function(a){if(!this._localAdded.contains(a)){persistence.add(a);this._localAdded.push(a)}};w.prototype.clone=function(){var a=s.prototype.clone.call(this);a._localAdded=this._localAdded;a._localRemoved=this._localRemoved;a._obj=this._obj;a._coll=this._coll;return a}; w.prototype.remove=function(a){if(this._localAdded.contains(a))this._localAdded.remove(a);else this._localRemoved.contains(a)||this._localRemoved.push(a)};w.prototype.persistQueries=function(){for(var a=[],b=persistence.getMeta(this._obj._type),c=b.hasMany[this._coll].type.meta,d=0;d<this._localAdded.length;d++)a.push(["INSERT INTO "+b.hasMany[this._coll].tableName+" (`"+b.name+"_"+this._coll+"`, `"+c.name+"_"+b.hasMany[this._coll].inverseProperty+"`) VALUES (?, ?)",[this._obj.id,this._localAdded[d].id]]); this._localAdded=[];for(d=0;d<this._localRemoved.length;d++)a.push(["DELETE FROM "+b.hasMany[this._coll].tableName+" WHERE `"+b.name+"_"+this._coll+"` = ? AND `"+c.name+"_"+b.hasMany[this._coll].inverseProperty+"` = ?",[this._obj.id,this._localRemoved[d].id]]);this._localRemoved=[];return a};x.prototype=new l;x.prototype.clone=function(){var a=s.prototype.clone.call(this);a._items=this._items;return a};x.prototype.add=function(a){this._items.push(a);this.triggerEvent("add",this,a);this.triggerEvent("change", this,a)};x.prototype.remove=function(a){for(var b=this._items,c=0;c<b.length;c++)if(b[c]===a){this._items.splice(c,1);this.triggerEvent("remove",this,a);this.triggerEvent("change",this,a)}};x.prototype.list=function(a,b){if(!a||a.executeSql)a=b;for(var c=this._items.slice(0),d=this,e=[],g=0;g<c.length;g++)this._filter.match(c[g])&&e.push(c[g]);e.sort(function(h,i){for(var f=0;f<d._orderColumns.length;f++){var j=d._orderColumns[f][0],k=d._orderColumns[f][1];if(h[j]<i[j])return k?-1:1;else if(h[j]> i[j])return k?1:-1}return 0});this._skip&&e.splice(0,this._skip);if(this._limit>-1)e=e.slice(0,this._limit);if(a)a(e);else return e};persistence.QueryCollection=l;persistence.LocalQueryCollection=x;persistence.Observable=F;persistence.db=persistence.db||{};persistence.db.implementation="unsupported";persistence.db.conn=null;persistence.db.log=true;if(window&&window.openDatabase)persistence.db.implementation="html5";else if(window&&window.google&&google.gears)persistence.db.implementation="gears"; else if(openDatabaseSync)persistence.db.implementation="html5-sync";persistence.db.html5={};persistence.db.html5.connect=function(a,b,c,d){var e={},g=openDatabase(a,d,b,c);e.transaction=function(h){return g.transaction(function(i){return h(persistence.db.html5.transaction(i))})};return e};persistence.db.html5.transaction=function(a){var b={};b.executeSql=function(c,d,e,g){persistence.db.log&&console.log(c);a.executeSql(c,d,function(h,i){if(e){for(var f=[],j=0;j<i.rows.length;j++)f.push(i.rows.item(j)); e(f)}},g)};return b};persistence.db.html5Sync={};persistence.db.html5Sync.connect=function(a,b,c,d){var e={},g=openDatabaseSync(a,d,b,c);e.transaction=function(h){return g.transaction(function(i){return h(persistence.db.html5Sync.transaction(i))})};return e};persistence.db.html5Sync.transaction=function(a){var b={};b.executeSql=function(c,d,e){if(d==null)d=[];persistence.db.log&&console.log(c+" -> "+d);if(c=a.executeSql(c,d))if(e){d=[];for(var g=0;g<c.rows.length;g++)d.push(c.rows.item(g));e(d)}}; return b};persistence.db.gears={};persistence.db.gears.connect=function(a){var b={},c=google.gears.factory.create("beta.database");c.open(a);b.transaction=function(d){d(persistence.db.gears.transaction(c))};return b};persistence.db.gears.transaction=function(a){var b={};b.executeSql=function(c,d,e){persistence.db.log&&console.log(c);c=a.execute(c,d);if(e){for(d=[];c.isValidRow();){for(var g={},h=0;h<c.fieldCount();h++)g[c.fieldName(h)]=c.field(h);d.push(g);c.next()}e(d)}};return b};persistence.db.connect= function(a,b,c,d){d=d||"1.0";if(persistence.db.implementation=="html5")return persistence.db.html5.connect(a,b,c,d);else if(persistence.db.implementation=="html5-sync")return persistence.db.html5Sync.connect(a,b,c,d);else if(persistence.db.implementation=="gears")return persistence.db.gears.connect(a)}})();Number.prototype.equals=function(m){return this==m};Boolean.prototype.equals=function(m){return this==m};String.prototype.equals=function(m){return this==m}; Array.prototype.equals=function(m){if(this.length!==m.length)return false;for(var p=0;p<this.length;p++)if(!this[p].equals(m[p]))return false;return true};Array.prototype.contains=function(m){for(var p=this.length,r=0;r<p;r++)if(this[r].equals(m))return true;return false};Array.prototype.remove=function(m){for(var p=this.length,r=0;r<p;r++)this[r].equals(m)&&this.splice(r,1)};
